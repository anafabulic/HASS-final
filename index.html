<!DOCTYPE html>
<html>
<head>

    <meta charset="UTF-8">
    <title>Singapore's Longest Bus Routes</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="css/styles.css">

</head>

<body>

<div class="grid">

    <div class="block gutter">
        <h1>Whatever Happened To The Long Bus Ride?</h1>
        <br>
    </div>

    <div class="block gutter">
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Sit amet tellus cras adipiscing. Euismod nisi porta lorem mollis aliquam. Nisl rhoncus mattis rhoncus urna neque. Dictumst quisque sagittis purus sit amet. Commodo quis imperdiet massa tincidunt nunc pulvinar sapien et. Ac turpis egestas integer eget aliquet nibh. Feugiat sed lectus vestibulum mattis. Elementum integer enim neque volutpat. Ipsum dolor sit amet consectetur adipiscing elit. Quisque sagittis purus sit amet. Id diam vel quam elementum pulvinar etiam. Non sodales neque sodales ut etiam sit. Pharetra vel turpis nunc eget.
        </p>
    </div>

    <div class="block gutter">
        <svg id="all_buses"></svg>
    </div>

    <div class="block gutter">
        <p>
            Enim eu turpis egestas pretium aenean pharetra. Et odio pellentesque diam volutpat commodo sed egestas egestas fringilla. Id venenatis a condimentum vitae sapien pellentesque habitant. Nibh sed pulvinar proin gravida hendrerit. Arcu non sodales neque sodales ut etiam sit. Aliquam eleifend mi in nulla. Vitae elementum curabitur vitae nunc sed velit dignissim sodales. Aliquam ultrices sagittis orci a scelerisque purus semper. Congue quisque egestas diam in. Metus dictum at tempor commodo. Sed sed risus pretium quam vulputate dignissim suspendisse. Ac ut consequat semper viverra. Vel pharetra vel turpis nunc eget lorem dolor sed viverra. Rhoncus est pellentesque elit ullamcorper dignissim cras. Dui nunc mattis enim ut tellus.
        </p>
    </div>

    <div class="block gutter">
        <svg id="longest_shortest"></svg>
        <div class="svg_ls_input" style="text-align:center;"></div>
    </div>

    <div class="block gutter">
        <p>
            Eget aliquet nibh praesent tristique magna sit amet purus gravida. Est ultricies integer quis auctor elit sed vulputate mi. Posuere lorem ipsum dolor sit amet consectetur adipiscing elit. Varius duis at consectetur lorem. Lacus vestibulum sed arcu non odio euismod lacinia at. Nisl vel pretium lectus quam id leo in. Viverra nibh cras pulvinar mattis. Auctor urna nunc id cursus metus aliquam eleifend. Amet tellus cras adipiscing enim. Malesuada proin libero nunc consequat interdum varius sit amet. Venenatis a condimentum vitae sapien pellentesque habitant morbi. Orci ac auctor augue mauris augue neque. Donec adipiscing tristique risus nec feugiat in fermentum posuere urna. Quam lacus suspendisse faucibus interdum posuere.
        </p>
    </div>

    <div class="block gutter">
        <svg id="route_lengths"></svg>
    </div>

    <div class="block gutter">
        <p>
            Eget aliquet nibh praesent tristique magna sit amet purus gravida. Est ultricies integer quis auctor elit sed vulputate mi. Posuere lorem ipsum dolor sit amet consectetur adipiscing elit. Varius duis at consectetur lorem. Lacus vestibulum sed arcu non odio euismod lacinia at. Nisl vel pretium lectus quam id leo in. Viverra nibh cras pulvinar mattis. Auctor urna nunc id cursus metus aliquam eleifend. Amet tellus cras adipiscing enim. Malesuada proin libero nunc consequat interdum varius sit amet. Venenatis a condimentum vitae sapien pellentesque habitant morbi. Orci ac auctor augue mauris augue neque. Donec adipiscing tristique risus nec feugiat in fermentum posuere urna. Quam lacus suspendisse faucibus interdum posuere.
        </p>
    </div>

    <div class="block gutter">
        <svg id="route_viewer"></svg>
    </div>

    <div class="block gutter" style="height:100px;">
        <div>
            <p>
                Source(s): etc. etc. etc.
            </p>
            <p>
                Credits: etc. etc. etc.
            </p>
        </div>
    </div>

</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>

// Define dimensions
let w = 1000, h = 600, gutter = 20;

// Define helper functions

// 1. Ordinal generator
let ordinal = (number) => {
    let ordinalRules = new Intl.PluralRules("en", {
        type: "ordinal"
    });
    let suffixes = {
        one: "st",
        two: "nd",
        few: "rd",
        other: "th"
    };
    let suffix = suffixes[ordinalRules.select(number)];
    return (number + suffix);
}

// Define d3 selections
let svg_ab = d3.select("svg#all_buses")
    .attr("viewBox", `0 0 ${w} ${h}`);
let svg_ls = d3.select("svg#longest_shortest")
    .attr("viewBox", `0 0 ${w} ${h}`);
let svg_rl = d3.select("svg#route_lengths")
    .attr("viewBox", `0 0 ${w} ${h}`);
let svg_rv = d3.select("svg#route_viewer")
    .attr("viewBox", `0 0 ${w} ${h}`);

// Define URIs
let data_uri = "https://raw.githubusercontent.com/anafabulic/HASS-final/main/json/service_summary.json";
let basemap_uri = "https://raw.githubusercontent.com/anafabulic/HASS-final/main/json/sg_plnarea_simple.geojson";
let stop_coords_uri = "https://raw.githubusercontent.com/anafabulic/HASS-final/main/json/stop_coords.json";
let stop_counts_uri = "https://raw.githubusercontent.com/anafabulic/HASS-final/main/json/stop_counts.json";

Promise.all(
    [   d3.json(data_uri),
        d3.json(basemap_uri),
        d3.json(stop_coords_uri),
        d3.json(stop_counts_uri)   ]).then(data => {
    
    // Define variables/objects; rewind data[0] as basemap
    let routes = data[0];
    let basemap = data[1];
    let basemap_r = basemap.features;
    for (let i = 0; i < basemap_r.length; i++) {
        if (basemap_r[i].geometry.type == "MultiPolygon") {
            for (let j = 0; j < basemap_r[i].geometry.coordinates.length; j++) {
                basemap_r[i].geometry.coordinates[j][0].reverse();
            }
        } else {
            basemap_r[i].geometry.coordinates[0].reverse();
        }
    }; 
    basemap.features = basemap_r;
    let stop_coords = data[2];
    let stop_counts = data[3];
    let ranges = {};

    console.log(basemap);
    console.log(routes);
    console.log(stop_coords);
    console.log(stop_counts);

// 1. Drawing svg all_buses
        
    // Define d3 projection
    let projection = d3.geoMercator()
        .fitExtent(
            [
                [gutter, gutter],
                [w - gutter, h - gutter]
            ],
            basemap
        );
    let geopath = d3.geoPath().projection(projection);

    // Draw map
    svg_ab.append("g")
        .attr("class", "basemap")
        .selectAll("path")
        .data(basemap.features)
        .enter()
        .append("path")
        .attr("d", geopath);
    
    // Build + clean stop data 
    let stops = [];
    Object.entries(stop_coords).forEach(function(item) {
        stops.push(
            {
                "stop":      item[0],
                "latitude":  item[1][0],
                "longitude": item[1][1],
                "count":     stop_counts[item[0]]
            }
        );
    });
    stops.sort((a,b) => {
        return a.count - b.count;
    });
    
    // Calculate min and max stopcounts
    ranges.svg_ab = [1e6, 0] // [min, max]
    stops.forEach(function(item) {
        if (item.count < ranges.svg_ab[0]) {
            ranges.svg_ab[0] = item.count;
        }
        if (item.count > ranges.svg_ab[1]) {
            ranges.svg_ab[1] = item.count;
        }
    });

    // Construct colorscale, radius scale, etc.
    let cs_svg_ab = d3.scaleSequential()
        .domain(ranges.svg_ab)
        .range([0.95,0.05]); // not pegging [1,0] because if you're setting size of points/spikes by d.count you want a reasonable nonzero somewhere.
    let cs_svg_r = 6.5;
    function cs_svg_r_maker(float) {
        return ((1 - cs_svg_ab(float))*cs_svg_r) + 1
    };

    // Draw the stops
    // TODO: slider that filters most-used stops from lesser-used stops?
    // TODO: or a button that changes the view to hexbin/counts?
    // see : https://observablehq.com/@mbostock/walmarts-growth 
    svg_ab.append("g")
        .selectAll("circle")
        .data(stops)
        .join(
            function(enter) {
                return enter
                    .append("circle")
                    .attr("class", "svg_ab_pts")
                    .attr("cx", d => projection([d.longitude, d.latitude])[0] )
                    .attr("cy", d => projection([d.longitude, d.latitude])[1] )
                    .attr("id", d => d.stop)
                    .attr("r", "0.01px")
                    // .attr("fill-opacity", d => (1 - cs_svg_ab(d.count)))
            }
        )
        .transition()
        .delay(d => (1-cs_svg_ab(d.count))*1300) // fancy fade-in based on d.count
        .duration(1000)
        .attr("r", d => cs_svg_r_maker(d.count).toString() + "px")
        .attr("fill-opacity", "0.85")
        .attr("fill", d => d3.interpolateInferno(cs_svg_ab(d.count)));

// 2. Drawing svg longest_shortest

    // Draw basemap
    svg_ls.append("g")
        .attr("class", "basemap")
        .selectAll("path")
        .data(basemap.features)
        .enter()
        .append("path")
        .attr("d", geopath);
    
    // Input box
    d3.select("div.svg_ls_input")
        .append("input")
        .attr("type", "text")
        .attr("style", "font-size: 1.2em;font-family: Lato")
        .attr("size", "10%")
        .attr("name", "ls_input")
        .attr("id", "ls_input")
        .attr("placeholder", "\u2000e.g. 61, 410W");

    // Populate route data .
    let svg_ls_data = [];
    routes.forEach(function(item, index) {
        // Create a geoJSON linestring between consecutive bus stops, then append all linestrings to a single 'links' dataset
        let stoplist = item.stops; 
        let links = [];
        for (var i=0, len=stoplist.length-1; i<len; i++) {
            links.push({
                type: "LineString",
                coordinates: [
                    [stoplist[i].longitude, stoplist[i].latitude],
                    [stoplist[i+1].longitude, stoplist[i+1].latitude]        
                ]
            });
        };
        svg_ls_data.push({
            route_no: item.route,
            route: links,
            length: item.length,
            max_km: item.max_km,
            ordinal: index + 1
        });  
    });
    let svg_ls_g = svg_ls.append("g")
            .attr("id", "svg_ls_routes");
    
    // Draw the links
    // TODO: Time-based update that can be paused and manually-set via textbox
    function update_ls(data) {
        data.forEach(function(item) {
            svg_ls_g.selectAll("path")
                .data(item.route)
                .join(
                    function(enter) {
                        return enter
                            .append("path")
                            .attr("class", "svg_ls_ln")
                            .attr("stroke-opacity", "0.01");
                    },
                    function(update) {
                        return update
                            .transition()
                            .duration(1000)
                            .attr("stroke-opacity", "0.01");
                    },
                    function(exit) {
                        return exit
                            .transition()
                            .duration(750)
                            .attr("stroke-opacity", "0.01")
                            .on("end", function() {
                                d3.select(this).remove();
                            });
                    }
                )
                .transition()
                .duration(1000)
                .attr("stroke-opacity", "0.35")
                .attr("d",geopath);
        });
    };

    let svg_ls_text = svg_ls.append("g")
        .attr("id", "svg_ls_txt");
    
    function update_ls_text(data) {
        // Add pointer to label
        svg_ls_text.selectAll("path")
            .data(data)
            .join(
                function(enter) {
                    return enter
                        .append("path")
                        .attr("class", "svg_ls_ptr");
                },
                function(update) {
                    return update
                },
                function(exit) {
                    return exit
                        .transition()
                        .duration(750)
                        .attr("stroke-opacity", "0.01")
                        .on("end", function() {
                            d3.select(this).remove();
                        });      
                }
            )
            .attr("stroke-opacity", "0.75")
            .transition()
            .duration(1000)
            .attr("d", d => 
                "M" + projection(d.route[0].coordinates[0])[0] +
                "," + projection(d.route[0].coordinates[0])[1] +
                "L" + "730" +
                "," + "510"
            );
        
        // Hack to 'buffer' the label
        svg_ls_text.selectAll("rect")
            .data(data)
            .join(
                function(enter) {
                    return enter
                        .append("rect")
                        .attr("x", "700")
                        .attr("y", "490")
                        .attr("width", "100px")
                        .attr("height", "100px")
                        .attr("fill", "var(--bg0)")
                        .attr("transform", "translate(-15, -30)");
                }
            );

        // Add label
        let textspace = svg_ls_text.selectAll("text")
            .data(data)
            .join(
                function(enter) {
                    return enter
                        .append("text")
                        .attr("class", data.route_no)
                        .attr("transform", "translate(700,490)");
                },
                function(exit) {
                    return exit
                        .on("end", function() {
                            d3.select(this).remove();
                        });
                }
            );
        
        textspace.text(d => "Bus " + d.route_no)
            .attr("dy","0")
            .attr("font-size", "1.2em")
            .transition()
            .duration(1000)
            .attr("transform", "translate(700,490)");
        
        textspace.append("tspan")
            .attr("dy", "1.5em")
            .attr("x", 0)
            .attr("font-size", "0.6em")
            .text(d => d.length + " stops");

        textspace.append("tspan")
            .attr("dy", "1.5em")
            .attr("x", "0")
            .attr("font-size", "0.6em")
            .text(d => d.max_km + " km");

        textspace.append("tspan")
            .attr("dy", "1.5em")
            .attr("x", "0")
            .attr("font-size", "0.6em")
            .text(d => ordinal(d.ordinal) + "-longest line");

    };

    // Set initial values
    let initialValue = "51";
    let filteredArray = svg_ls_data.filter(function(obj) {
        return obj.route_no === initialValue;
    });
    update_ls(filteredArray);
    update_ls_text(filteredArray);

    // Listen to the input box
    d3.select("#ls_input").on("change", function(d) {

        let selectedValue = this.value;
        let filteredArray = svg_ls_data.filter(function(item) {
            return item.route_no === selectedValue;
        });

        // Hacky update trick: update_ls_text exits nicely on empty array, but update_ls panics if there are no elements in route[].
        // Hence: do the former, then populate route if filteredArray is empty, then do the latter.
        update_ls_text(filteredArray);
        if (filteredArray.length == 0) {
            filteredArray.push({
                route_no: null,
                route: [{}],
                length: null,
                max_km: null,
                ordinal: null
            });
        };
        update_ls(filteredArray);
    });
    
    // The long, straight lines crossing the island are normal. They represent cross-island services with a very large distance between stops.

// 3. Drawing svg route_lengths (bar charts of route lengths)

// 4. Drawing svg route_viewer (live bus locator based on bus stop) (optional)

});

</script>

</body>
</html>

